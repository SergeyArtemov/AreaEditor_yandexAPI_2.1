-->>>-- Логирование здесь : [dbo].[ae_AreaIntervalList_Save_New2] --<<<--


--declare @xmltext varchar(max) = 
----'<INTERVAL_LIST USER="s.kholin" MINDATE="20170221" MAXDATE="20170331" AREAID="504" AREATYPE="0"><INTERVAL ID="0" AREAID="504" START="20170221 07:30" LEN="19000101 07:00" TYPE="0" /><INTERVAL ID="0" AREAID="504" START="20170222 14:30" LEN="19000101 07:00" TYPE="0" /><INTERVAL ID="0" AREAID="504" START="20170223 07:30" LEN="19000101 14:00" TYPE="0" /><INTERVAL ID="0" AREAID="504" START="20170224 07:30" LEN="19000101 07:00" TYPE="0" /><INTERVAL ID="0" AREAID="504" START="20170225 14:30" LEN="19000101 07:00" TYPE="0" /><INTERVAL ID="0" AREAID="504" START="20170226 07:30" LEN="19000101 14:00" TYPE="0" /><INTERVAL ID="0" AREAID="504" START="20170227 07:30" LEN="19000101 07:00" TYPE="0" /><INTERVAL ID="0" AREAID="504" START="20170228 14:30" LEN="19000101 07:00" TYPE="0" /><INTERVAL ID="0" AREAID="504" START="20170301 07:30" LEN="19000101 14:00" TYPE="0" /><INTERVAL ID="0" AREAID="504" START="20170302 07:30" LEN="19000101 07:00" TYPE="0" /><INTERVAL ID="0" AREAID="504" START="20170303 14:30" LEN="19000101 07:00" TYPE="0" /><INTERVAL ID="0" AREAID="504" START="20170304 07:30" LEN="19000101 14:00" TYPE="0" /><INTERVAL ID="0" AREAID="504" START="20170305 07:30" LEN="19000101 07:00" TYPE="0" /><INTERVAL ID="0" AREAID="504" START="20170306 14:30" LEN="19000101 07:00" TYPE="0" /><INTERVAL ID="0" AREAID="504" START="20170307 07:30" LEN="19000101 14:00" TYPE="0" /><INTERVAL ID="0" AREAID="504" START="20170308 07:30" LEN="19000101 07:00" TYPE="0" /><INTERVAL ID="0" AREAID="504" START="20170309 14:30" LEN="19000101 07:00" TYPE="0" /><INTERVAL ID="0" AREAID="504" START="20170310 07:30" LEN="19000101 14:00" TYPE="0" /><INTERVAL ID="0" AREAID="504" START="20170311 07:30" LEN="19000101 07:00" TYPE="0" /><INTERVAL ID="0" AREAID="504" START="20170312 14:30" LEN="19000101 07:00" TYPE="0" /><INTERVAL ID="0" AREAID="504" START="20170313 07:30" LEN="19000101 14:00" TYPE="0" /><INTERVAL ID="0" AREAID="504" START="20170314 07:30" LEN="19000101 07:00" TYPE="0" /><INTERVAL ID="0" AREAID="504" START="20170315 14:30" LEN="19000101 07:00" TYPE="0" /><INTERVAL ID="0" AREAID="504" START="20170316 07:30" LEN="19000101 14:00" TYPE="0" /><INTERVAL ID="0" AREAID="504" START="20170317 07:30" LEN="19000101 07:00" TYPE="0" /><INTERVAL ID="0" AREAID="504" START="20170318 14:30" LEN="19000101 07:00" TYPE="0" /><INTERVAL ID="0" AREAID="504" START="20170319 07:30" LEN="19000101 14:00" TYPE="0" /><INTERVAL ID="0" AREAID="504" START="20170320 07:30" LEN="19000101 07:00" TYPE="0" /><INTERVAL ID="0" AREAID="504" START="20170321 14:30" LEN="19000101 07:00" TYPE="0" /><INTERVAL ID="0" AREAID="504" START="20170322 07:30" LEN="19000101 14:00" TYPE="0" /><INTERVAL ID="0" AREAID="504" START="20170323 07:30" LEN="19000101 07:00" TYPE="0" /><INTERVAL ID="0" AREAID="504" START="20170324 14:30" LEN="19000101 07:00" TYPE="0" /><INTERVAL ID="0" AREAID="504" START="20170325 07:30" LEN="19000101 14:00" TYPE="0" /><INTERVAL ID="0" AREAID="504" START="20170326 07:30" LEN="19000101 07:00" TYPE="0" /><INTERVAL ID="0" AREAID="504" START="20170327 14:30" LEN="19000101 07:00" TYPE="0" /><INTERVAL ID="0" AREAID="504" START="20170328 07:30" LEN="19000101 14:00" TYPE="0" /><INTERVAL ID="0" AREAID="504" START="20170329 07:30" LEN="19000101 07:00" TYPE="0" /><INTERVAL ID="0" AREAID="504" START="20170330 14:30" LEN="19000101 07:00" TYPE="0" /><INTERVAL ID="0" AREAID="504" START="20170331 07:30" LEN="19000101 14:00" TYPE="0" /></INTERVAL_LIST>'
--'<ROOT><HEADER HOST="TRANSPORT04" USER="dvv" IP="10.10.142.24:57699" DT="20170216 12:55:36:133"/><DATA><ATF id="592854" AreaId="510" Start="2017-03-18T09:00:00" Len="1900-01-01T13:00:00"/></DATA></ROOT>'

--declare @AreaId			int
--declare @prevValues		xml = CAST(@xmltext as xml)
--if IsNull(@AreaID,0) = 0 
--   select @AreaId = t.r.value('@AreaId[1]','int') from @prevValues.nodes('ROOT/DATA/ATF') as t(r)
--select @AreaId
--GO



declare @xmltext varchar(max) = 
--'<INTERVAL_LIST USER="s.kholin" MINDATE="20170221" MAXDATE="20170331" AREAID="504" AREATYPE="0"><INTERVAL ID="0" AREAID="504" START="20170221 07:30" LEN="19000101 07:00" TYPE="0" /><INTERVAL ID="0" AREAID="504" START="20170222 14:30" LEN="19000101 07:00" TYPE="0" /><INTERVAL ID="0" AREAID="504" START="20170223 07:30" LEN="19000101 14:00" TYPE="0" /><INTERVAL ID="0" AREAID="504" START="20170224 07:30" LEN="19000101 07:00" TYPE="0" /><INTERVAL ID="0" AREAID="504" START="20170225 14:30" LEN="19000101 07:00" TYPE="0" /><INTERVAL ID="0" AREAID="504" START="20170226 07:30" LEN="19000101 14:00" TYPE="0" /><INTERVAL ID="0" AREAID="504" START="20170227 07:30" LEN="19000101 07:00" TYPE="0" /><INTERVAL ID="0" AREAID="504" START="20170228 14:30" LEN="19000101 07:00" TYPE="0" /><INTERVAL ID="0" AREAID="504" START="20170301 07:30" LEN="19000101 14:00" TYPE="0" /><INTERVAL ID="0" AREAID="504" START="20170302 07:30" LEN="19000101 07:00" TYPE="0" /><INTERVAL ID="0" AREAID="504" START="20170303 14:30" LEN="19000101 07:00" TYPE="0" /><INTERVAL ID="0" AREAID="504" START="20170304 07:30" LEN="19000101 14:00" TYPE="0" /><INTERVAL ID="0" AREAID="504" START="20170305 07:30" LEN="19000101 07:00" TYPE="0" /><INTERVAL ID="0" AREAID="504" START="20170306 14:30" LEN="19000101 07:00" TYPE="0" /><INTERVAL ID="0" AREAID="504" START="20170307 07:30" LEN="19000101 14:00" TYPE="0" /><INTERVAL ID="0" AREAID="504" START="20170308 07:30" LEN="19000101 07:00" TYPE="0" /><INTERVAL ID="0" AREAID="504" START="20170309 14:30" LEN="19000101 07:00" TYPE="0" /><INTERVAL ID="0" AREAID="504" START="20170310 07:30" LEN="19000101 14:00" TYPE="0" /><INTERVAL ID="0" AREAID="504" START="20170311 07:30" LEN="19000101 07:00" TYPE="0" /><INTERVAL ID="0" AREAID="504" START="20170312 14:30" LEN="19000101 07:00" TYPE="0" /><INTERVAL ID="0" AREAID="504" START="20170313 07:30" LEN="19000101 14:00" TYPE="0" /><INTERVAL ID="0" AREAID="504" START="20170314 07:30" LEN="19000101 07:00" TYPE="0" /><INTERVAL ID="0" AREAID="504" START="20170315 14:30" LEN="19000101 07:00" TYPE="0" /><INTERVAL ID="0" AREAID="504" START="20170316 07:30" LEN="19000101 14:00" TYPE="0" /><INTERVAL ID="0" AREAID="504" START="20170317 07:30" LEN="19000101 07:00" TYPE="0" /><INTERVAL ID="0" AREAID="504" START="20170318 14:30" LEN="19000101 07:00" TYPE="0" /><INTERVAL ID="0" AREAID="504" START="20170319 07:30" LEN="19000101 14:00" TYPE="0" /><INTERVAL ID="0" AREAID="504" START="20170320 07:30" LEN="19000101 07:00" TYPE="0" /><INTERVAL ID="0" AREAID="504" START="20170321 14:30" LEN="19000101 07:00" TYPE="0" /><INTERVAL ID="0" AREAID="504" START="20170322 07:30" LEN="19000101 14:00" TYPE="0" /><INTERVAL ID="0" AREAID="504" START="20170323 07:30" LEN="19000101 07:00" TYPE="0" /><INTERVAL ID="0" AREAID="504" START="20170324 14:30" LEN="19000101 07:00" TYPE="0" /><INTERVAL ID="0" AREAID="504" START="20170325 07:30" LEN="19000101 14:00" TYPE="0" /><INTERVAL ID="0" AREAID="504" START="20170326 07:30" LEN="19000101 07:00" TYPE="0" /><INTERVAL ID="0" AREAID="504" START="20170327 14:30" LEN="19000101 07:00" TYPE="0" /><INTERVAL ID="0" AREAID="504" START="20170328 07:30" LEN="19000101 14:00" TYPE="0" /><INTERVAL ID="0" AREAID="504" START="20170329 07:30" LEN="19000101 07:00" TYPE="0" /><INTERVAL ID="0" AREAID="504" START="20170330 14:30" LEN="19000101 07:00" TYPE="0" /><INTERVAL ID="0" AREAID="504" START="20170331 07:30" LEN="19000101 14:00" TYPE="0" /></INTERVAL_LIST>'
--'<INTERVAL_LIST MINDATE="20170221" MAXDATE="20170331" AREATYPE="0"><INTERVAL ID="0" AREAID="504" START="20170221 07:30" LEN="19000101 07:00" TYPE="0" /></INTERVAL_LIST>'
--'<ROOT><HEADER HOST="TRANSPORT04" USER="dvv" IP="10.10.142.24:57699" DT="20170216 12:55:36:133"/><DATA><ATF id="592854" AreaId="510" Start="2017-03-18T09:00:00" Len="1900-01-01T13:00:00"/></DATA></ROOT>'
'<INTERVAL_LIST USER="s.kholin">
<INTERVAL ID="712975" AREAID="1111" START="20170221 09:00:00.000" LEN="19000101 10:00:00.000" TYPE="0" /></INTERVAL_LIST>'


declare @xml xml = cast(@xmltext as xml)
declare @out table (ID int)
declare @temp table(ID int, AreaID int,[Start] datetime, [Len] datetime)
insert into @temp
 select 
   t.r.value('@ID','int')								as [ID]
  ,t.r.value('@AREAID','int')							as [AreaId]
  ,CAST(t.r.value('@START','datetime2(0)') as datetime)	as [Start]
  ,CAST(t.r.value('@LEN','datetime2(0)') as datetime)	as [Len]
from @xml.nodes('/INTERVAL_LIST/INTERVAL') as t(r)
where IsNull(t.r.value('@TYPE','int'),0)=0 -- TAreaIntervalIdType (0 для областей)


begin try
declare @AreaId			int
declare @WorkStation	varchar(100)
declare @user			varchar(64)
declare @ipdata			varchar(64)
declare @prevValues		xml 
set @prevValues= 
(select ATF.[id], ATF.[AreaId] ,ATF.[Start] , ATF.[Len]
from dbo.map_AreaTime_Full_New(nolock) ATF
right join @temp T on T.AreaID = ATF.AreaId and CAST(T.Start as date) = CAST(ATF.Start as date)
where ATF.AreaId is not NULL
order by T.AreaID, T.Start
for XML AUTO, ROOT('DATA')) 
select 
   @AreaId		= t.r.value('@AREAID','int')			
  ,@User		= t.r.value('@USER'	 ,'varchar(100)')	
from @xml.nodes('/INTERVAL_LIST') as t(r)
select
   @WorkStation	= HOST_NAME()
  ,@ipdata		= [client_net_address]+':'+cast([client_tcp_port] as varchar)
from [master].[sys].[dm_exec_connections](nolock) 
where [session_id]=@@SPID

--select 0,@AreaID
if IsNull(@AreaID,0) = 0 
   select @AreaId = t.r.value('@AREAID','int') from @xml.nodes('/INTERVAL_LIST/INTERVAL') as t(r)
--select 1,@AreaID
if IsNull(@AreaID,0) = 0 
   select @AreaId = t.r.value('@AreaId','int') from @prevValues.nodes('DATA/ATF') as t(r)
--select 2,@AreaID

--
--insert [dbo].[map_AreaTime_ChangeLog]([AreaId],[DateEdit],[xml],[WorkStation],[User],[ipdata])

select 
 [AreaID]
,[DateEdit]
,[xml]
,CAST([xml] as xml) as [True xml]
,[WorkStation]
,[User]
,[ipdata]
from (
select 
 @AreaId		as [AreaID]
,getdate()		as [DateEdit]
,'<ROOT>'+
 '<HEADER HOST="'+HOST_NAME()+'"'+
        ' USER="'+SYSTEM_USER+'"'+
        ' IP="'+[client_net_address]+':'+cast([client_tcp_port] as varchar)+'"'+
		' DT="'+CONVERT(varchar(20),getdate(),112)+' '+CONVERT(varchar(20),getdate(),114)+'"'+
 '/>'+
 IsNULL(CAST(@prevValues as varchar(max)),'')+
 '<INPUT>'+@xmltext+'</INPUT>'+
 '</ROOT>'		as [xml]
,@WorkStation	as [WorkStation]
,@user			as [User]
,@ipdata		as [ipdata]
FROM [master].[sys].[dm_exec_connections](nolock)
  where [session_id]=@@SPID
) src
end try
begin catch
end catch

